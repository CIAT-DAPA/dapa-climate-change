!     Fortran90 subroutines for General Large-Area Model for annual crops (GLAM)
!     Release 2, created from Release 1 during 2007-2008.
!     Copyright The University of Reading and the University of Leeds 2008. All rights reserved.

!Output and sorage subroutines:
! OUTPUT       : daily ascii file
! STORE_VARS   : store variables for spatial output
! OUTPUT_AS    : ASCII spatial output 
! OUTPUT_NC    : NETCDF spatial output 
! OUTPUT_MERIT : Merit function (including YGP-calibration) output

      SUBROUTINE OUTPUT(XVAR,IDAP,POT)
!C     Outputs data to daily output file
!C
!C     ------------------------------------------------------------------
!C     Input     : 
!C     In        : 
!C     Out       : 
!C     Output    : 
!C     Called by : Main
!C     Calls     : 
!C     ------------------------------------------------------------------
!C
      USE GLOBAL_VARS
      USE IO_VARS
      USE HIGHT_VARS
      IMPLICIT NONE
      REAL :: XVAR,TOUT,VOUT,DSW,PESW,RLA_NORM,TMINOUT,TMAXOUT
      INTEGER :: IDAP,IFILE
      LOGICAL :: POT

      !OUTPUT FILE CALCULATIONS
      
      IFILE=IFLDAILY
      IF (IDAP.GE.1.) THEN 
         VOUT=VPDTOT/FLOAT(IDAP)
         TOUT=TBARTOT/FLOAT(IDAP)
         TMINOUT=TMINTOT/FLOAT(IDAP)
         TMAXOUT=TMAXTOT/FLOAT(IDAP)
      ELSE
         VOUT=FLOAT(NODATA)
         TOUT=FLOAT(NODATA)
         TMINOUT=FLOAT(NODATA)
         TMAXOUT=FLOAT(NODATA)
      ENDIF
      IF (POT) THEN
         PESW=RNOVAL
         DSW=RNOVAL
      ELSE
         PESW=SWATER-(RLL*DZ*FLOAT(NSL))
         DSW=SWATER-VOLSWS*S_THICK
      ENDIF
      IF (RLAI(2)>0.AND..NOT.POT) THEN
         RLA_NORM=RLA/RLAI(2)
      ELSE
         RLA_NORM=FLOAT(NODATA)
      ENDIF


      !WRITE TO FILE
      WRITE(IFILE,OUTFMT4)XVAR,CHAR(9),ISTG &
           ,CHAR(9),RLV_MEAN &
           ,CHAR(9),RLAI(2) &
           ,CHAR(9),YIELD &
           ,CHAR(9),BMASS &
           ,CHAR(9),MIN(SLA,999.99) &
           ,CHAR(9),HI &
           ,CHAR(9),T_RAIN &
           ,CHAR(9),SRAD(IDAP) &
           ,CHAR(9),PESW &
           ,CHAR(9),TRANS &
           ,CHAR(9),ET &
           ,CHAR(9),P_TRANS+P_EVAP &
           ,CHAR(9),SWFAC &
           ,CHAR(9),EVAP+TRANS &
           ,CHAR(9),RUNOFF &
           ,CHAR(9),T_RUN &
           ,CHAR(9),DTPUPTK &
           ,CHAR(9),TP_UP &
           ,CHAR(9),DRAIN &
           ,CHAR(9),T_DRAIN &
           ,CHAR(9),P_TRANS &
           ,CHAR(9),TP_TRANS &
           ,CHAR(9),T_EVAP &
           ,CHAR(9),TP_EVAP &
           ,CHAR(9),T_TRANS &
           ,CHAR(9),RLA &
           ,CHAR(9),MIN(RLA_NORM,999.99) &
           ,CHAR(9),RAIN(IDAP) &
           ,CHAR(9),DSW   &
           ,CHAR(9),TRADABS &
           ,CHAR(9),FLOAT(IDAP-ISDAY) &
           ,CHAR(9),VOUT &
           ,CHAR(9),VPDTOT &
           ,CHAR(9),VPD &
           ,CHAR(9),C_EVAP &
           ,CHAR(9),TMINOUT &
           ,CHAR(9),TOTPP_HIT & ! TMAXOUT &
		   ,CHAR(9),TOTPP &
		   ,CHAR(9),DHDT_HT !&
!           ,CHAR(9),TOUT !&
!              ,CHAR(9),-99.!TRADNET &
!              ,CHAR(9),TOTPP &
!              ,CHAR(9),TOTPP_HIT &
!              ,CHAR(9),TOTPP_WAT  
      RETURN 
      END SUBROUTINE OUTPUT




      SUBROUTINE STORE_VARS(IDAP,POT)
      USE GLOBAL_VARS
      USE MULTI_VARS
      USE HIGHT_VARS
      IMPLICIT NONE
      INTEGER :: IDAP, IY
      REAL :: RLA_NORM,PESW,DSW
      LOGICAL :: POT

      IY=IYR-ISYR+1

      IF (POT) THEN
         PESW=RNOVAL
         DSW=RNOVAL
      ELSE
         PESW=SWATER-(RLL*DZ*FLOAT(NSL))
         DSW=SWATER-VOLSWS*S_THICK
      ENDIF
      IF (RLAI(2)>0.AND..NOT.POT) THEN
         RLA_NORM=RLA/RLAI(2)
      ELSE
         RLA_NORM=FLOAT(NODATA)
      ENDIF

!     IPLANT dimension added to STORE by KJN to save multiple planting date info
      STORE(IY,ILAT,ILON,IPLANT,1)=RLV_MEAN
      STORE(IY,ILAT,ILON,IPLANT,2)=RLAI(2)
      STORE(IY,ILAT,ILON,IPLANT,3)=YIELD ! "3" Must change in SR merit and if changed here
      STORE(IY,ILAT,ILON,IPLANT,4)=BMASS
      STORE(IY,ILAT,ILON,IPLANT,5)=MIN(SLA,999.99) !Avoids ***** in output
      STORE(IY,ILAT,ILON,IPLANT,6)=HI
      STORE(IY,ILAT,ILON,IPLANT,7)=T_RAIN
      STORE(IY,ILAT,ILON,IPLANT,8)=SRAD(IDAP)
      STORE(IY,ILAT,ILON,IPLANT,9)=PESW
      STORE(IY,ILAT,ILON,IPLANT,10)=TRANS
      STORE(IY,ILAT,ILON,IPLANT,11)=ET
      STORE(IY,ILAT,ILON,IPLANT,12)=P_TRANS+P_EVAP
      STORE(IY,ILAT,ILON,IPLANT,13)=SWFAC
      STORE(IY,ILAT,ILON,IPLANT,14)=EVAP+TRANS
      STORE(IY,ILAT,ILON,IPLANT,15)=RUNOFF
      STORE(IY,ILAT,ILON,IPLANT,16)=T_RUN
      STORE(IY,ILAT,ILON,IPLANT,17)=DTPUPTK
      STORE(IY,ILAT,ILON,IPLANT,18)=TP_UP
      STORE(IY,ILAT,ILON,IPLANT,19)=DRAIN
      STORE(IY,ILAT,ILON,IPLANT,20)=T_DRAIN
      STORE(IY,ILAT,ILON,IPLANT,21)=P_TRANS
      STORE(IY,ILAT,ILON,IPLANT,22)=TP_TRANS
      STORE(IY,ILAT,ILON,IPLANT,23)=T_EVAP
      STORE(IY,ILAT,ILON,IPLANT,24)=TP_EVAP
      STORE(IY,ILAT,ILON,IPLANT,25)=T_TRANS
      STORE(IY,ILAT,ILON,IPLANT,26)=RLA
      STORE(IY,ILAT,ILON,IPLANT,27)=MIN(RLA_NORM,999.99)
      STORE(IY,ILAT,ILON,IPLANT,28)=RAIN(IDAP)
      STORE(IY,ILAT,ILON,IPLANT,29)=DSW     
      STORE(IY,ILAT,ILON,IPLANT,30)=TRADABS
      STORE(IY,ILAT,ILON,IPLANT,31)=FLOAT(IDAP-ISDAY) !Duration        
      IF (IDAP.GE.1.) THEN 
         STORE(IY,ILAT,ILON,IPLANT,32)=VPDTOT/FLOAT(IDAP)
         STORE(IY,ILAT,ILON,IPLANT,37)=TBARTOT/FLOAT(IDAP)
      ELSE
         STORE(IY,ILAT,ILON,IPLANT,32)=FLOAT(NODATA)
         STORE(IY,ILAT,ILON,IPLANT,37)=FLOAT(NODATA)
      ENDIF
      STORE(IY,ILAT,ILON,IPLANT,33)=TRADNET
      IF (LHIGHT) THEN
         STORE(IY,ILAT,ILON,IPLANT,34)=TOTPP! was: FLOAT(NTSTRES)! No. of high T stress days
         STORE(IY,ILAT,ILON,IPLANT,35)=TOTPP_HIT
         STORE(IY,ILAT,ILON,IPLANT,36)=TOTPP_WAT         
      ELSE
         STORE(IY,ILAT,ILON,IPLANT,34)=1.
         STORE(IY,ILAT,ILON,IPLANT,35)=1.
         STORE(IY,ILAT,ILON,IPLANT,36)=1.
      ENDIF
      IPSAVE(ILAT,ILON,IY,IPLANT)=IPDATE+MAX(ISDAY,1) !Save intellegent planting date; max is in case ISDAY=-99
      ISTGSAVE(ILAT,ILON,IY,IPLANT)=ISTG !Save final stage of plant growth
      RETURN
      END SUBROUTINE STORE_VARS


      
      SUBROUTINE OUTPUT_AS
!C     Outputs data to spatial ASCII file
!
      USE GLOBAL_VARS
      USE IO_VARS
      USE MULTI_VARS
      IMPLICIT NONE
      INTEGER :: IV,IY
      CHARACTER(LEN=666666) :: DUMMY1, DUMMY2
      CHARACTER(LEN=2) :: DUMMYCHAR

!     KJN modified to produce a groundnut.out file for each planting
      DO IPLANT=1,NPLANT
       IF (IPLANT.LT.10) WRITE(DUMMYCHAR,'(I1)')IPLANT
       IF ((IPLANT.GE.10).AND.(IPLANT.LT.100)) WRITE(DUMMYCHAR,'(I2)')IPLANT
       OPEN(UNIT=IFLASC,FILE=TRIM(OUTDIR)//TRIM(CROP)//TRIM(DUMMYCHAR)//'.out')
       DO IYR=ISYR,IEYR
          IY=IYR-ISYR+1
          DO ILAT=1,NLAT
             DO ILON=1,NLON
               IF(OBS_YLD(ILAT,ILON,IY).GE.0) THEN !Kathryn Nicklin - only output sim yields where there is an obs yield
                IF (JSKIP(ILAT,ILON)==1) THEN
                   CONTINUE
                ELSE
                   WRITE(IFLASC,OUTFMT2)IYR,CHAR(9),RLATMAT(ILAT),CHAR(9),RLONMAT(ILON),CHAR(9),IPSAVE(ILAT,ILON,IY,IPLANT),CHAR(9),ISTGSAVE(ILAT,ILON,IY,IPLANT),(CHAR(9),STORE(IYR-ISYR+1,ILAT,ILON,IPLANT,IV),IV=1,NVARS)
                ENDIF
               ENDIF
             ENDDO
          ENDDO
       ENDDO
       CLOSE(IFLASC)
      ENDDO

!     Following added by Kathryn Nicklin June 2010 to produce seperate output files
!     for each gridcell
!     If I want to use this again need to modify to cope with multiple planting dates each year
!      DO ILAT=1,NLAT
!       DO ILON=1,NLON
!        WRITE(UNIT=DUMMY1,FMT='(F6.1)')RLATMAT(ILAT)
!        WRITE(UNIT=DUMMY2,FMT='(F6.1)')RLONMAT(ILON)
!        OPEN(UNIT=IFLASC,FILE=TRIM(OUTDIR)//TRIM(CROP)//'_'//TRIM(ADJUSTL(DUMMY1))//'N_'//TRIM(ADJUSTL(DUMMY2))//'E.out')
!        DO IYR=ISYR,IEYR
!         WRITE(IFLASC,OUTFMT3) IYR,CHAR(9),RLATMAT(ILAT),CHAR(9),RLONMAT(ILON),CHAR(9),IPSAVE(ILAT,ILON,IYR-ISYR+1),CHAR(9),ISTGSAVE(ILAT,ILON,IYR-ISYR+1),(CHAR(9),STORE(IYR-ISYR+1,ILAT,ILON,IV),IV=1,NVARS),CHAR(9),OBS_YLD(ILAT,ILON,IYR-ISYR+1)
!        ENDDO
!        CLOSE(IFLASC)
!       ENDDO
!      ENDDO

      RETURN 
      END SUBROUTINE OUTPUT_AS





 SUBROUTINE OUTPUT_NC(POT)
   USE GLOBAL_VARS
   USE IO_VARS
   USE MULTI_VARS
   IMPLICIT NONE
   INCLUDE '/nfs/see-fs-01_app1/netcdf/include/netcdf.inc'
   INTEGER :: NCID,ISTAT,LONID,LATID,TIMID,IY,IVAR,J,JJ,IDUM
   INTEGER, DIMENSION(3) ::DTADIM,ISTART,ICOUNT,ISTEP
   REAL :: TIM(ISYR:IEYR),DTA(NLON,NLAT,ISYR:IEYR),DTA2D(NLON,NLAT)
   REAL, DIMENSION (NLAT,NLON) :: COR,RMSE,MFE
   LOGICAL :: POT
   INTEGER, PARAMETER :: NVARSC=7,NVARSW=12,NVARSCD=5,NVARSD=6
   INTEGER :: ICROP(NVARSC),IWAT(NVARSW),IDC(NVARSC),IDW(NVARSW),IDCD(NVARSCD),IDD(NVARSD),IDEX(3)
   CHARACTER(LEN=2) :: DUMMYCHAR

   !To add spare inputs from STORE, simply increase NVARSC, 
   ! fill in the values for Spare in DATA ICROP,
   ! and uncomment spare001-3 below

   DATA ICROP /2,3,4,6,30,31,33/!,Spare1,Spare2,Spare3/ !Indices of STORE which contain crop/weather info
   DATA IWAT  /1,7,9,16,18,20,22,23,24,25,26,29/ !" which contain water balance info
   IDEX(1)=101
   IDEX(2)=102
   IDEX(3)=103

   !CALCULATE MERITS FOR OUTPUT
   SD_OBS(:,:)=RNCNODATA
   MEANX(:,:)=0.0    
   COR(:,:)=RNCNODATA
   RMSE(:,:)=RNCNODATA
   MFE(:,:)=RNCNODATA
   DO ILAT=1,NLAT
      DO ILON=1,NLON
         IF (JSKIP(ILAT,ILON)==0) THEN
            CALL MCALC(ILAT,ILAT,ILON,ILON,IDUM,.FALSE.)
            COR(ILAT,ILON)=RMERIT(4)
            RMSE(ILAT,ILON)=RMERIT(1)
            MFE(ILAT,ILON)=RMERIT(3) !Mean fractional error
         ENDIF
      ENDDO
   ENDDO

   DO IPLANT=1,NPLANT
    IF (IPLANT.LT.10) WRITE(DUMMYCHAR,'(I1)')IPLANT
    IF ((IPLANT.GE.10).AND.(IPLANT.LT.100)) WRITE(DUMMYCHAR,'(I2)')IPLANT
    !Define data dimensions - long, lat, time
    ISTAT=NF_CREATE(TRIM(OUTDIR)//TRIM(CROP)//TRIM(DUMMYCHAR)//'.nc',0,NCID)
    ISTAT=NF_PUT_ATT_TEXT(NCID,NF_GLOBAL,'missing_value',5,'2e+20')
    ISTAT=NF_DEF_DIM(NCID,'longitude',NLON,LONID)
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(1,ISTAT,IINFFIL)
    ISTAT=NF_DEF_DIM(NCID,'latitude',NLAT,LATID)
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(2,ISTAT,IINFFIL)
    ISTAT=NF_DEF_DIM(NCID,'time',IEYR-ISYR+1,TIMID)
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(3,ISTAT,IINFFIL)
    DTADIM(1)=LONID
    DTADIM(2)=LATID
    DTADIM(3)=TIMID   
    ISTAT=NF_DEF_VAR(NCID,'longitude',NF_REAL,1,LONID,LONID)
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(4,ISTAT,IINFFIL)
    ISTAT=NF_DEF_VAR(NCID,'latitude',NF_REAL,1,LATID,LATID)
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(5,ISTAT,IINFFIL)
    ISTAT=NF_DEF_VAR(NCID,'time',NF_REAL,1,TIMID,TIMID)
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(6,ISTAT,IINFFIL)
    !Define crop model-variables (Must be done in ICROP order)
    ISTAT=NF_DEF_VAR(NCID,'LAI',     NF_REAL,3,DTADIM,IDC(1))
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(71,ISTAT,IINFFIL)
    ISTAT=NF_DEF_VAR(NCID,'Yield',   NF_REAL,3,DTADIM,IDC(2))
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(72,ISTAT,IINFFIL)
    ISTAT=NF_DEF_VAR(NCID,'Biomass', NF_REAL,3,DTADIM,IDC(3))
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(73,ISTAT,IINFFIL)
    ISTAT=NF_DEF_VAR(NCID,'HI',      NF_REAL,3,DTADIM,IDC(4))
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(74,ISTAT,IINFFIL)
    ISTAT=NF_DEF_VAR(NCID,'TRadAbs', NF_REAL,3,DTADIM,IDC(5))
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(75,ISTAT,IINFFIL)
    ISTAT=NF_DEF_VAR(NCID,'Duration',NF_REAL,3,DTADIM,IDC(6))
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(76,ISTAT,IINFFIL)
    ISTAT=NF_DEF_VAR(NCID,'TRadNet',NF_REAL,3,DTADIM,IDC(7))
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(77,ISTAT,IINFFIL)
!   ISTAT=NF_DEF_VAR(NCID,'Spare001',NF_REAL,3,DTADIM,IDC(8)) !1
!   IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(78,ISTAT,IINFFIL)
!   ISTAT=NF_DEF_VAR(NCID,'Spare002',NF_REAL,3,DTADIM,IDC(9))
!   IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(79,ISTAT,IINFFIL)
!   ISTAT=NF_DEF_VAR(NCID,'Spare003',NF_REAL,3,DTADIM,IDC(10))
!   IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(80,ISTAT,IINFFIL) !2
    !Define water balance model-variables (Must be done in IWAT order)
    IF (.NOT.POT) THEN
       ISTAT=NF_DEF_VAR(NCID,'RLVMean',    NF_REAL,3,DTADIM,IDW(1)) 
       IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(81,ISTAT,IINFFIL)
       ISTAT=NF_DEF_VAR(NCID,'TotRain',    NF_REAL,3,DTADIM,IDW(2)) 
       IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(82,ISTAT,IINFFIL)
       ISTAT=NF_DEF_VAR(NCID,'FinalPESW',  NF_REAL,3,DTADIM,IDW(3)) 
       IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(83,ISTAT,IINFFIL)
       ISTAT=NF_DEF_VAR(NCID,'TotRunoff',  NF_REAL,3,DTADIM,IDW(4)) 
       IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(84,ISTAT,IINFFIL)
       ISTAT=NF_DEF_VAR(NCID,'TotPotUp',   NF_REAL,3,DTADIM,IDW(5)) 
       IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(85,ISTAT,IINFFIL)
       ISTAT=NF_DEF_VAR(NCID,'TotDrain',   NF_REAL,3,DTADIM,IDW(6)) 
       IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(86,ISTAT,IINFFIL)
       ISTAT=NF_DEF_VAR(NCID,'TotPotTrans',NF_REAL,3,DTADIM,IDW(7)) 
       IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(87,ISTAT,IINFFIL)
       ISTAT=NF_DEF_VAR(NCID,'TotEvap',    NF_REAL,3,DTADIM,IDW(8)) 
       IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(88,ISTAT,IINFFIL)
       ISTAT=NF_DEF_VAR(NCID,'TotPotEvap', NF_REAL,3,DTADIM,IDW(9)) 
       IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(89,ISTAT,IINFFIL)
       ISTAT=NF_DEF_VAR(NCID,'TotTrans',   NF_REAL,3,DTADIM,IDW(10)) 
       IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(90,ISTAT,IINFFIL)
       ISTAT=NF_DEF_VAR(NCID,'RLA',        NF_REAL,3,DTADIM,IDW(11)) 
       IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(91,ISTAT,IINFFIL)
       ISTAT=NF_DEF_VAR(NCID,'DSW',        NF_REAL,3,DTADIM,IDW(12)) 
       IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(92,ISTAT,IINFFIL)
    ENDIF
    !Define crop data variables 
    ISTAT=NF_DEF_VAR(NCID,'ObsMeanYield', NF_REAL,2,DTADIM(1:2),IDCD(1))
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(100,ISTAT,IINFFIL)
    ISTAT=NF_DEF_VAR(NCID,'ObsSDevYield',   NF_REAL,2,DTADIM(1:2),IDCD(2))
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(101,ISTAT,IINFFIL)
    ISTAT=NF_DEF_VAR(NCID,'YieldCorObsSim',   NF_REAL,2,DTADIM(1:2),IDCD(3))
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(101,ISTAT,IINFFIL)
    ISTAT=NF_DEF_VAR(NCID,'YieldRMSE',   NF_REAL,2,DTADIM(1:2),IDCD(4))
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(101,ISTAT,IINFFIL)
    ISTAT=NF_DEF_VAR(NCID,'YieldMeanFracErr',   NF_REAL,2,DTADIM(1:2),IDCD(5))
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(101,ISTAT,IINFFIL)


    !Define diagnostic variables
    ISTAT=NF_DEF_VAR(NCID,'YGP', NF_REAL,3,DTADIM,IDD(1))
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(110,ISTAT,IINFFIL)
    ISTAT=NF_DEF_VAR(NCID,'PDATE',NF_REAL,3,DTADIM,IDD(2))
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(111,ISTAT,IINFFIL)
    ISTAT=NF_DEF_VAR(NCID,'ISTG', NF_REAL,3,DTADIM,IDD(3))
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(112,ISTAT,IINFFIL)
    ISTAT=NF_DEF_VAR(NCID,'TOTPP', NF_REAL,3,DTADIM,IDD(4))
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(113,ISTAT,IINFFIL)
    ISTAT=NF_DEF_VAR(NCID,'TOTPP_HIT', NF_REAL,3,DTADIM,IDD(5))
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(114,ISTAT,IINFFIL)
    ISTAT=NF_DEF_VAR(NCID,'TOTPP_WAT', NF_REAL,3,DTADIM,IDD(6))
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(115,ISTAT,IINFFIL)
    !Define season-mean VPD and mean temperature
    ISTAT=NF_DEF_VAR(NCID,'MeanVPD', NF_REAL,3,DTADIM,IDEX(1))
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(120,ISTAT,IINFFIL)
    ISTAT=NF_DEF_VAR(NCID,'MeanTBar', NF_REAL,3,DTADIM,IDEX(2))
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(121,ISTAT,IINFFIL)
    !Define Aug2005 new variables
    ISTAT=NF_DEF_VAR(NCID,'SLA', NF_REAL,3,DTADIM,IDEX(3))
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(123,ISTAT,IINFFIL)

    !Finish off
    ISTAT=NF_ENDDEF(NCID)
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(8,ISTAT,IINFFIL)

    !Set up variables for NF_PUT_dta
    ISTART(1)=1
    ISTART(2)=1
    ISTART(3)=1
    ICOUNT(1)=NLON
    ICOUNT(2)=NLAT
    ICOUNT(3)=IEYR-ISYR+1
    ISTEP(1)=1
    ISTEP(2)=1
    ISTEP(3)=1
    DO IY=ISYR,IEYR
       TIM(IY)=FLOAT(IY)
    ENDDO

    !Write Lat, lont and time data
    ISTAT=NF_PUT_VAR_REAL(NCID,LONID,RLONMAT(ISTART(1):(ISTART(1)+ICOUNT(1)-1)))
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(140,ISTAT,IINFFIL)
    ISTAT=NF_PUT_VAR_REAL(NCID,LATID,RLATMAT(ISTART(2):(ISTART(2)+ICOUNT(2)-1)))
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(141,ISTAT,IINFFIL)
    ISTAT=NF_PUT_VAR_REAL(NCID,TIMID,TIM)
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(142,ISTAT,IINFFIL)
    !Write crop model-variables
    DO IVAR=1,NVARSC
       DTA=RNCNODATA
       DO ILON=1,NLON
          DO ILAT=1,NLAT
             DTA(ILON,ILAT,:)=STORE(1:IEYR-ISYR+1,ILAT,ILON,IPLANT,ICROP(IVAR)) 
          ENDDO
       ENDDO
       ISTAT=NF_PUT_VARS_REAL(NCID,IDC(IVAR),ISTART,ICOUNT,ISTEP,DTA)   
       IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(160+IVAR,ISTAT,IINFFIL)
    ENDDO
    !Write water balance model-variables
    IF (.NOT.POT) THEN
       DO IVAR=1,NVARSW
          DTA=RNCNODATA
          DO ILON=1,NLON
             DO ILAT=1,NLAT
                DTA(ILON,ILAT,:)=STORE(1:IEYR-ISYR+1,ILAT,ILON,IPLANT,IWAT(IVAR)) 
             ENDDO
          ENDDO
          ISTAT=NF_PUT_VARS_REAL(NCID,IDW(IVAR),ISTART,ICOUNT,ISTEP,DTA)   
          IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(180+IVAR,ISTAT,IINFFIL)
       ENDDO
    ENDIF
    !Write crop data and model-data comparison variables 
    DTA2D=RNCNODATA !First
    DO ILON=1,NLON
       DO ILAT=1,NLAT
          DTA2D(ILON,ILAT)=MEANX(ILAT,ILON)
       ENDDO
    ENDDO
    ISTAT=NF_PUT_VARS_REAL(NCID,IDCD(1),ISTART,ICOUNT,ISTEP,DTA2D)   
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(200,ISTAT,IINFFIL)
    DTA2D=RNCNODATA !Second
    DO ILON=1,NLON
       DO ILAT=1,NLAT
          DTA2D(ILON,ILAT)=SD_OBS(ILAT,ILON)
       ENDDO
    ENDDO
    ISTAT=NF_PUT_VARS_REAL(NCID,IDCD(2),ISTART,ICOUNT,ISTEP,DTA2D)   
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(201,ISTAT,IINFFIL)
    DTA2D=RNCNODATA !Third
    DO ILON=1,NLON
       DO ILAT=1,NLAT
          DTA2D(ILON,ILAT)=COR(ILAT,ILON)
       ENDDO
    ENDDO
    ISTAT=NF_PUT_VARS_REAL(NCID,IDCD(3),ISTART,ICOUNT,ISTEP,DTA2D)   
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(201,ISTAT,IINFFIL)
    DTA2D=RNCNODATA
    DTA2D=RNCNODATA !Fourth
    DO ILON=1,NLON
       DO ILAT=1,NLAT
          DTA2D(ILON,ILAT)=RMSE(ILAT,ILON)
       ENDDO
    ENDDO
    ISTAT=NF_PUT_VARS_REAL(NCID,IDCD(4),ISTART,ICOUNT,ISTEP,DTA2D)   
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(201,ISTAT,IINFFIL)
    DTA2D=RNCNODATA
    DTA2D=RNCNODATA !Fifth
    DO ILON=1,NLON
       DO ILAT=1,NLAT
          DTA2D(ILON,ILAT)=MFE(ILAT,ILON)
       ENDDO
    ENDDO
    ISTAT=NF_PUT_VARS_REAL(NCID,IDCD(5),ISTART,ICOUNT,ISTEP,DTA2D)   
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(201,ISTAT,IINFFIL)
    DTA2D=RNCNODATA

    !Write crop diagnostic variables
    DTA=RNCNODATA !First 
    WHERE (YGPMAT < TESTNODATA) YGPMAT=RNCNODATA
    DO ILON=1,NLON
       DO ILAT=1,NLAT
          DTA(ILON,ILAT,ISYR:IEYR) = YGPMAT(ILAT,ILON)
       ENDDO
    ENDDO
    ISTAT=NF_PUT_VARS_REAL(NCID,IDD(1),ISTART,ICOUNT,ISTEP,DTA)   
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(221,ISTAT,IINFFIL)
    DTA=RNCNODATA !Second
    RIPSAVE=FLOAT(IPSAVE)
    WHERE (RIPSAVE<TESTNODATA) RIPSAVE=RNCNODATA
    DO ILON=1,NLON
       DO ILAT=1,NLAT
          DTA(ILON,ILAT,:)=RIPSAVE(ILAT,ILON,1:IEYR-ISYR+1,IPLANT)
       ENDDO
    ENDDO
    ISTAT=NF_PUT_VARS_REAL(NCID,IDD(2),ISTART,ICOUNT,ISTEP,DTA)   
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(222,ISTAT,IINFFIL)
    DTA=RNCNODATA !Third
    DO ILON=1,NLON
       DO ILAT=1,NLAT
          DTA(ILON,ILAT,:)=ISTGSAVE(ILAT,ILON,1:IEYR-ISYR+1,IPLANT)
       ENDDO
    ENDDO
    WHERE (DTA<TESTNODATA) DTA=RNCNODATA !Kathryn Nicklin added this line
    ISTAT=NF_PUT_VARS_REAL(NCID,IDD(3),ISTART,ICOUNT,ISTEP,DTA)   
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(223,ISTAT,IINFFIL)
    DTA=RNCNODATA !Fourth
    DO ILON=1,NLON
       DO ILAT=1,NLAT
          DO IY=1,IEYR-ISYR+1
             DTA(ILON,ILAT,IY+ISYR-1) = STORE(IY,ILAT,ILON,IPLANT,34) !TOTPP
          ENDDO
       ENDDO
    ENDDO
    ISTAT=NF_PUT_VARS_REAL(NCID,IDD(4),ISTART,ICOUNT,ISTEP,DTA)   
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(224,ISTAT,IINFFIL)
    DTA=RNCNODATA !Fifth
    DO ILON=1,NLON
       DO ILAT=1,NLAT
          DO IY=1,IEYR-ISYR+1
             DTA(ILON,ILAT,IY+ISYR-1)= STORE(IY,ILAT,ILON,IPLANT,35) !TOTPP_HIT
          ENDDO
       ENDDO
    ENDDO
    ISTAT=NF_PUT_VARS_REAL(NCID,IDD(5),ISTART,ICOUNT,ISTEP,DTA)   
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(225,ISTAT,IINFFIL)
    DTA=RNCNODATA !Sixth
    DO ILON=1,NLON
       DO ILAT=1,NLAT
          DO IY=1,IEYR-ISYR+1
             DTA(ILON,ILAT,IY+ISYR-1) = STORE(IY,ILAT,ILON,IPLANT,36) !TOTPP_WAT
          ENDDO
       ENDDO
    ENDDO
    ISTAT=NF_PUT_VARS_REAL(NCID,IDD(6),ISTART,ICOUNT,ISTEP,DTA)   
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(226,ISTAT,IINFFIL)

    !Write 'extra' outputs (season-mean VPD and mean temperature)
    DTA=RNCNODATA
    DO ILON=1,NLON
       DO ILAT=1,NLAT
          DTA(ILON,ILAT,:)=STORE(1:IEYR-ISYR+1,ILAT,ILON,IPLANT,32)
       ENDDO
    ENDDO
    ISTAT=NF_PUT_VARS_REAL(NCID,IDEX(1),ISTART,ICOUNT,ISTEP,DTA)   
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(227,ISTAT,IINFFIL)
    DTA=RNCNODATA
    DO ILON=1,NLON
       DO ILAT=1,NLAT
          DTA(ILON,ILAT,:)=STORE(1:IEYR-ISYR+1,ILAT,ILON,IPLANT,37)
       ENDDO
    ENDDO
    ISTAT=NF_PUT_VARS_REAL(NCID,IDEX(2),ISTART,ICOUNT,ISTEP,DTA)   
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(228,ISTAT,IINFFIL)

    !New outputs added Aug 2005
    !1 - SLA as fn of time and space
    DTA=RNCNODATA
    DO ILON=1,NLON
       DO ILAT=1,NLAT
          DTA(ILON,ILAT,:)=STORE(1:IEYR-ISYR+1,ILAT,ILON,IPLANT,5) 
       ENDDO
    ENDDO
    ISTAT=NF_PUT_VARS_REAL(NCID,IDEX(3),ISTART,ICOUNT,ISTEP,DTA)   
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(229,ISTAT,IINFFIL)

    !Finish off
    ISTAT=NF_CLOSE(NCID)
    IF(ISTAT.NE.NF_NOERR) CALL NC_WRITE_ERROR(9,ISTAT,IINFFIL)
   ENDDO

 END SUBROUTINE OUTPUT_NC




 SUBROUTINE NC_WRITE_ERROR(IDONTHINKSOBOB,I,IF)
   IMPLICIT NONE
   INTEGER :: I,IF,IDONTHINKSOBOB
   INCLUDE '/nfs/see-fs-01_app1/netcdf/include/netcdf.inc'
   WRITE(IF,*)'SR OUTPUT_NC: NetCDF write error at ',IDONTHINKSOBOB
   WRITE(IF,*)NF_STRERROR(I)
   STOP
 END SUBROUTINE NC_WRITE_ERROR


